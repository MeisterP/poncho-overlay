From d705e4bb2b7efd4166d46d6fcb3183212902707c Mon Sep 17 00:00:00 2001
From: Mike Perry <mikeperry-git@torproject.org>
Date: Tue, 28 Aug 2012 18:22:32 -0700
Subject: [PATCH 18/19] Adapt Steven Michaud's Mac crashfix patch

Source is: https://bugzilla.mozilla.org/show_bug.cgi?id=715885#c35

Some minor tweaks were needed to get it to apply and to compile on
MacOS.
---
 widget/Makefile.in                        |    1 +
 widget/cocoa/nsChildView.mm               |   28 +++++++++++------
 widget/gtk2/nsDragService.cpp             |    9 +++--
 widget/nsIDragService.idl                 |    4 +--
 widget/nsPIDragService.idl                |   48 +++++++++++++++++++++++++++++
 widget/qt/nsDragService.h                 |    2 +
 widget/windows/Makefile.in                |    4 ++
 widget/windows/nsDragService.cpp          |   13 +++++---
 widget/windows/nsDragService.h            |   12 +++---
 widget/windows/nsNativeDragSource.cpp     |    7 ++--
 widget/windows/nsNativeDragTarget.cpp     |   28 ++++++++++------
 widget/windows/nsPIDragServiceWindows.idl |   46 +++++++++++++++++++++++++++
 widget/xpwidgets/nsBaseDragService.cpp    |   16 +++++++++-
 widget/xpwidgets/nsBaseDragService.h      |    9 ++---
 14 files changed, 179 insertions(+), 48 deletions(-)
 create mode 100644 widget/nsPIDragService.idl
 create mode 100644 widget/windows/nsPIDragServiceWindows.idl

diff --git a/widget/Makefile.in b/widget/Makefile.in
index f1df966..eb6eec2 100644
--- a/widget/Makefile.in
+++ b/widget/Makefile.in
@@ -105,6 +105,7 @@ XPIDLSRCS	= \
 		nsIClipboardDragDropHooks.idl \
 		nsIClipboardDragDropHookList.idl \
 		nsIDragSession.idl \
+		nsPIDragService.idl \
 		nsIDragService.idl \
 		nsIFormatConverter.idl \
 		nsIClipboard.idl \
diff --git a/widget/cocoa/nsChildView.mm b/widget/cocoa/nsChildView.mm
index 9cbc1e3..92b93cb 100644
--- a/widget/cocoa/nsChildView.mm
+++ b/widget/cocoa/nsChildView.mm
@@ -4513,11 +4513,12 @@ NSEvent* gLastDragMouseDownEvent = nil;
   if (!dragService) {
     dragService = do_GetService(kDragServiceContractID);
   }
+  nsCOMPtr<nsPIDragService> dragServicePriv = do_QueryInterface(dragService);
 
   if (dragService) {
     NSPoint pnt = [NSEvent mouseLocation];
     FlipCocoaScreenCoordinate(pnt);
-    dragService->DragMoved(NSToIntRound(pnt.x), NSToIntRound(pnt.y));
+    dragServicePriv->DragMoved(NSToIntRound(pnt.x), NSToIntRound(pnt.y));
   }
 }
 
@@ -4538,11 +4539,13 @@ NSEvent* gLastDragMouseDownEvent = nil;
   }
 
   if (mDragService) {
-    // set the dragend point from the current mouse location
-    nsDragService* dragService = static_cast<nsDragService *>(mDragService);
-    NSPoint pnt = [NSEvent mouseLocation];
-    FlipCocoaScreenCoordinate(pnt);
-    dragService->SetDragEndPoint(nsIntPoint(NSToIntRound(pnt.x), NSToIntRound(pnt.y)));
+    nsCOMPtr<nsPIDragService> dragServicePriv = do_QueryInterface(mDragService);
+    if (dragServicePriv) {
+      // set the dragend point from the current mouse location
+      NSPoint pnt = [NSEvent mouseLocation];
+      FlipCocoaScreenCoordinate(pnt);
+      dragServicePriv->SetDragEndPoint(NSToIntRound(pnt.x), NSToIntRound(pnt.y));
+    }
 
     // XXX: dropEffect should be updated per |operation|. 
     // As things stand though, |operation| isn't well handled within "our"
@@ -4553,10 +4556,15 @@ NSEvent* gLastDragMouseDownEvent = nil;
     // value for NSDragOperationGeneric that is passed by other applications.
     // All that said, NSDragOperationNone is still reliable.
     if (operation == NSDragOperationNone) {
-      nsCOMPtr<nsIDOMDataTransfer> dataTransfer;
-      dragService->GetDataTransfer(getter_AddRefs(dataTransfer));
-      if (dataTransfer)
-        dataTransfer->SetDropEffectInt(nsIDragService::DRAGDROP_ACTION_NONE);
+      nsCOMPtr<nsIDragSession> dragSession;
+      mDragService->GetCurrentSession(getter_AddRefs(dragSession));
+      if (dragSession) {
+        nsCOMPtr<nsIDOMDataTransfer> dataTransfer;
+        dragSession->GetDataTransfer(getter_AddRefs(dataTransfer));
+        if (dataTransfer) {
+            dataTransfer->SetDropEffectInt(nsIDragService::DRAGDROP_ACTION_NONE);
+        }
+      }
     }
 
     mDragService->EndDragSession(true);
diff --git a/widget/gtk2/nsDragService.cpp b/widget/gtk2/nsDragService.cpp
index e0ff5d6..2c10c10 100644
--- a/widget/gtk2/nsDragService.cpp
+++ b/widget/gtk2/nsDragService.cpp
@@ -239,8 +239,8 @@ OnSourceGrabEventAfter(GtkWidget *widget, GdkEvent *event, gpointer user_data)
         // Update the cursor position.  The last of these recorded gets used for
         // the NS_DRAGDROP_END event.
         nsDragService *dragService = static_cast<nsDragService*>(user_data);
-        dragService->SetDragEndPoint(nsIntPoint(event->motion.x_root,
-                                                event->motion.y_root));
+        dragService->SetDragEndPoint(event->motion.x_root,
+                                     event->motion.y_root);
     } else if (sMotionEvent && (event->type != GDK_KEY_PRESS ||
                                 event->type != GDK_KEY_RELEASE)) {
         // Update modifier state from keypress events.
@@ -1348,7 +1348,7 @@ nsDragService::SourceEndDragSession(GdkDragContext *aContext,
         GdkDisplay* display = gdk_display_get_default();
         if (display) {
             gdk_display_get_pointer(display, NULL, &x, &y, NULL);
-            SetDragEndPoint(nsIntPoint(x, y));
+            SetDragEndPoint(x, y);
         }
     }
 
@@ -1765,8 +1765,9 @@ nsDragService::ScheduleDropEvent(nsWindow *aWindow,
         NS_WARNING("Additional drag drop ignored");
         return FALSE;        
     }
+    nsIntPoint pt = aWindowPoint + aWindow->WidgetToScreenOffset();
 
-    SetDragEndPoint(aWindowPoint + aWindow->WidgetToScreenOffset());
+    SetDragEndPoint(pt.x, pt.y);
 
     // We'll reply with gtk_drag_finish().
     return TRUE;
diff --git a/widget/nsIDragService.idl b/widget/nsIDragService.idl
index 196761e..c0565bb 100644
--- a/widget/nsIDragService.idl
+++ b/widget/nsIDragService.idl
@@ -15,7 +15,7 @@ interface nsIDOMDragEvent;
 interface nsIDOMDataTransfer;
 interface nsISelection;
 
-[scriptable, uuid(82B58ADA-F490-4C3D-B737-1057C4F1D052), builtinclass]
+[scriptable, uuid(82B58ADA-F490-4C3D-B737-1057C4F1D052)]
 interface nsIDragService : nsISupports
 {
   const long DRAGDROP_ACTION_NONE = 0;
@@ -112,8 +112,6 @@ interface nsIDragService : nsISupports
    */
   void suppress();
   void unsuppress();
-
-  [noscript] void dragMoved(in long aX, in long aY);
 };
 
 
diff --git a/widget/nsPIDragService.idl b/widget/nsPIDragService.idl
new file mode 100644
index 0000000..93a144d
--- /dev/null
+++ b/widget/nsPIDragService.idl
@@ -0,0 +1,48 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * The Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2012
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Steven Michaud <smichaud@pobox.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsISupports.idl"
+
+[scriptable, uuid(FAD8C90B-8E1D-446A-9B6C-241486A85CBD)]
+interface nsPIDragService : nsISupports
+{
+  void dragMoved(in long aX, in long aY);
+
+  PRUint16 getInputSource();
+
+  void setDragEndPoint(in long aX, in long aY);
+};
diff --git a/widget/qt/nsDragService.h b/widget/qt/nsDragService.h
index 393be99..56d0312 100644
--- a/widget/qt/nsDragService.h
+++ b/widget/qt/nsDragService.h
@@ -17,6 +17,8 @@ public:
     NS_DECL_ISUPPORTS
     NS_DECL_NSIDRAGSERVICE
 
+    NS_IMETHOD DragMoved(PRInt32 aX, PRInt32 aY);
+
     nsDragService();
 
 private:
diff --git a/widget/windows/Makefile.in b/widget/windows/Makefile.in
index 160c941..12f6dc7 100644
--- a/widget/windows/Makefile.in
+++ b/widget/windows/Makefile.in
@@ -88,6 +88,10 @@ ifdef MOZ_ENABLE_D3D10_LAYER
 DEFINES		+= -DMOZ_ENABLE_D3D10_LAYER
 endif
 
+XPIDLSRCS	+= \
+		nsPIDragServiceWindows.idl \
+		$(NULL)
+
 SHARED_LIBRARY_LIBS = \
   ../xpwidgets/$(LIB_PREFIX)xpwidgets_s.$(LIB_SUFFIX) \
   $(NULL)
diff --git a/widget/windows/nsDragService.cpp b/widget/windows/nsDragService.cpp
index efe8ce1..62e7d97 100644
--- a/widget/windows/nsDragService.cpp
+++ b/widget/windows/nsDragService.cpp
@@ -60,6 +60,8 @@ nsDragService::~nsDragService()
   NS_IF_RELEASE(mDataObject);
 }
 
+NS_IMPL_ISUPPORTS_INHERITED1(nsDragService, nsBaseDragService, nsPIDragServiceWindows)
+
 bool
 nsDragService::CreateDragImage(nsIDOMNode *aDOMNode,
                                nsIScriptableRegion *aRegion,
@@ -305,7 +307,7 @@ nsDragService::StartInvokingDragSession(IDataObject * aDataObj,
   POINT cpos;
   cpos.x = GET_X_LPARAM(pos);
   cpos.y = GET_Y_LPARAM(pos);
-  SetDragEndPoint(nsIntPoint(cpos.x, cpos.y));
+  SetDragEndPoint(cpos.x, cpos.y);
   EndDragSession(true);
 
   mDoingDrag = false;
@@ -423,25 +425,26 @@ nsDragService::GetData(nsITransferable * aTransferable, PRUint32 anItem)
 
 //---------------------------------------------------------
 NS_IMETHODIMP
-nsDragService::SetIDataObject(IDataObject * aDataObj)
+nsDragService::SetIDataObject(nsISupports * aDataObj)
 {
+  IDataObject *dataObj = (IDataObject*) aDataObj;
   // When the native drag starts the DragService gets
   // the IDataObject that is being dragged
   NS_IF_RELEASE(mDataObject);
-  mDataObject = aDataObj;
+  mDataObject = dataObj;
   NS_IF_ADDREF(mDataObject);
 
   return NS_OK;
 }
 
 //---------------------------------------------------------
-void
+NS_IMETHODIMP
 nsDragService::SetDroppedLocal()
 {
   // Sent from the native drag handler, letting us know
   // a drop occurred within the application vs. outside of it.
   mSentLocalDropEvent = true;
-  return;
+  return NS_OK;
 }
 
 //-------------------------------------------------------------------------
diff --git a/widget/windows/nsDragService.h b/widget/windows/nsDragService.h
index 93b5480..bd2125b 100644
--- a/widget/windows/nsDragService.h
+++ b/widget/windows/nsDragService.h
@@ -7,6 +7,7 @@
 #define nsDragService_h__
 
 #include "nsBaseDragService.h"
+#include "nsPIDragServiceWindows.h"
 #include <windows.h>
 #include <shlobj.h>
 
@@ -20,12 +21,15 @@ class  nsString;
  * Native Win32 DragService wrapper
  */
 
-class nsDragService : public nsBaseDragService
+class nsDragService : public nsBaseDragService, public nsPIDragServiceWindows
 {
 public:
   nsDragService();
   virtual ~nsDragService();
-  
+
+  NS_DECL_ISUPPORTS_INHERITED
+  NS_DECL_NSPIDRAGSERVICEWINDOWS
+
   // nsIDragService
   NS_IMETHOD InvokeDragSession(nsIDOMNode *aDOMNode,
                                nsISupportsArray *anArrayTransferables,
@@ -39,13 +43,9 @@ public:
   NS_IMETHOD EndDragSession(bool aDoneDrag);
 
   // native impl.
-  NS_IMETHOD SetIDataObject(IDataObject * aDataObj);
   NS_IMETHOD StartInvokingDragSession(IDataObject * aDataObj,
                                       PRUint32 aActionType);
 
-  // A drop occurred within the application vs. outside of it.
-  void SetDroppedLocal();
-
 protected:
   nsDataObjCollection* GetDataObjCollection(IDataObject * aDataObj);
 
diff --git a/widget/windows/nsNativeDragSource.cpp b/widget/windows/nsNativeDragSource.cpp
index e981ff9..e34613f 100644
--- a/widget/windows/nsNativeDragSource.cpp
+++ b/widget/windows/nsNativeDragSource.cpp
@@ -10,7 +10,7 @@
 #include "nsIServiceManager.h"
 #include "nsToolkit.h"
 #include "nsWidgetsCID.h"
-#include "nsIDragService.h"
+#include "nsDragService.h"
 
 static NS_DEFINE_IID(kCDragServiceCID,  NS_DRAGSERVICE_CID);
 
@@ -69,9 +69,10 @@ STDMETHODIMP
 nsNativeDragSource::QueryContinueDrag(BOOL fEsc, DWORD grfKeyState)
 {
   nsCOMPtr<nsIDragService> dragService = do_GetService(kCDragServiceCID);
-  if (dragService) {
+  nsCOMPtr<nsPIDragService> dragServicePriv = do_QueryInterface(dragService);
+  if (dragServicePriv) {
     DWORD pos = ::GetMessagePos();
-    dragService->DragMoved(GET_X_LPARAM(pos), GET_Y_LPARAM(pos));
+    dragServicePriv->DragMoved(GET_X_LPARAM(pos), GET_Y_LPARAM(pos));
   }
 
   if (fEsc) {
diff --git a/widget/windows/nsNativeDragTarget.cpp b/widget/windows/nsNativeDragTarget.cpp
index da1cd1f..96303c3 100644
--- a/widget/windows/nsNativeDragTarget.cpp
+++ b/widget/windows/nsNativeDragTarget.cpp
@@ -172,7 +172,11 @@ nsNativeDragTarget::DispatchDragDropEvent(PRUint32 aEventType, POINTL aPT)
   nsModifierKeyState modifierKeyState;
   modifierKeyState.InitInputEvent(event);
 
-  event.inputSource = static_cast<nsBaseDragService*>(mDragService)->GetInputSource();
+  event.inputSource = 0;
+  nsCOMPtr<nsPIDragService> dragServicePriv = do_QueryInterface(mDragService);
+  if (dragServicePriv) {
+    dragServicePriv->GetInputSource(&event.inputSource);
+  }
 
   mWindow->DispatchEvent(&event, status);
 }
@@ -259,9 +263,8 @@ nsNativeDragTarget::DragEnter(LPDATAOBJECT pIDataSource,
   // This cast is ok because in the constructor we created a
   // the actual implementation we wanted, so we know this is
   // a nsDragService. It should be a private interface, though.
-  nsDragService * winDragService =
-    static_cast<nsDragService *>(mDragService);
-  winDragService->SetIDataObject(pIDataSource);
+  nsCOMPtr<nsPIDragServiceWindows> winDragService = do_QueryInterface(mDragService);
+  winDragService->SetIDataObject((nsISupports*)pIDataSource);
 
   // Now process the native drag state and then dispatch the event
   ProcessDrag(NS_DRAGDROP_ENTER, grfKeyState, ptl, pdwEffect);
@@ -399,8 +402,8 @@ nsNativeDragTarget::Drop(LPDATAOBJECT pData,
   // This cast is ok because in the constructor we created a
   // the actual implementation we wanted, so we know this is
   // a nsDragService (but it should still be a private interface)
-  nsDragService* winDragService = static_cast<nsDragService*>(mDragService);
-  winDragService->SetIDataObject(pData);
+  nsCOMPtr<nsPIDragServiceWindows> winDragService = do_QueryInterface(mDragService);
+  winDragService->SetIDataObject((nsISupports*)pData);
 
   // NOTE: ProcessDrag spins the event loop which may destroy arbitrary objects.
   // We use strong refs to prevent it from destroying these:
@@ -424,11 +427,14 @@ nsNativeDragTarget::Drop(LPDATAOBJECT pData,
   // tell the drag service we're done with the session
   // Use GetMessagePos to get the position of the mouse at the last message
   // seen by the event loop. (Bug 489729)
-  DWORD pos = ::GetMessagePos();
-  POINT cpos;
-  cpos.x = GET_X_LPARAM(pos);
-  cpos.y = GET_Y_LPARAM(pos);
-  winDragService->SetDragEndPoint(nsIntPoint(cpos.x, cpos.y));
+  nsCOMPtr<nsPIDragService> dragServicePriv = do_QueryInterface(mDragService);
+  if (dragServicePriv) {
+    DWORD pos = ::GetMessagePos();
+    POINT cpos;
+    cpos.x = GET_X_LPARAM(pos);
+    cpos.y = GET_Y_LPARAM(pos);
+    dragServicePriv->SetDragEndPoint(cpos.x, cpos.y);
+  }
   serv->EndDragSession(true);
 
   // release the ref that was taken in DragEnter
diff --git a/widget/windows/nsPIDragServiceWindows.idl b/widget/windows/nsPIDragServiceWindows.idl
new file mode 100644
index 0000000..c8a46dd
--- /dev/null
+++ b/widget/windows/nsPIDragServiceWindows.idl
@@ -0,0 +1,46 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * The Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2012
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Steven Michaud <smichaud@pobox.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsISupports.idl"
+
+[scriptable, uuid(6FC2117D-5EB4-441A-9C12-62A783BEBC0C)]
+interface nsPIDragServiceWindows : nsISupports
+{
+  void setIDataObject(in nsISupports aDataObj);
+
+  void setDroppedLocal();
+};
diff --git a/widget/xpwidgets/nsBaseDragService.cpp b/widget/xpwidgets/nsBaseDragService.cpp
index 1b2ef0d..627ebd2 100644
--- a/widget/xpwidgets/nsBaseDragService.cpp
+++ b/widget/xpwidgets/nsBaseDragService.cpp
@@ -55,7 +55,7 @@ nsBaseDragService::~nsBaseDragService()
 {
 }
 
-NS_IMPL_ISUPPORTS2(nsBaseDragService, nsIDragService, nsIDragSession)
+NS_IMPL_ISUPPORTS3(nsBaseDragService, nsIDragService, nsPIDragService, nsIDragSession)
 
 //---------------------------------------------------------
 NS_IMETHODIMP
@@ -403,6 +403,20 @@ nsBaseDragService::DragMoved(PRInt32 aX, PRInt32 aY)
   return NS_OK;
 }
 
+NS_IMETHODIMP
+nsBaseDragService::SetDragEndPoint(PRInt32 aX, PRInt32 aY)
+{
+  mEndDragPoint = nsIntPoint(aX, aY);
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsBaseDragService::GetInputSource(PRUint16* aInputSource)
+{
+  *aInputSource = mInputSource;
+  return NS_OK;
+}
+
 static nsIPresShell*
 GetPresShellForContent(nsIDOMNode* aDOMNode)
 {
diff --git a/widget/xpwidgets/nsBaseDragService.h b/widget/xpwidgets/nsBaseDragService.h
index 006747f..d825b53 100644
--- a/widget/xpwidgets/nsBaseDragService.h
+++ b/widget/xpwidgets/nsBaseDragService.h
@@ -7,6 +7,7 @@
 #define nsBaseDragService_h__
 
 #include "nsIDragService.h"
+#include "nsPIDragService.h"
 #include "nsIDragSession.h"
 #include "nsITransferable.h"
 #include "nsISupportsArray.h"
@@ -32,6 +33,7 @@ class nsICanvasElementExternal;
  */
 
 class nsBaseDragService : public nsIDragService,
+                          public nsPIDragService,
                           public nsIDragSession
 {
 
@@ -42,14 +44,11 @@ public:
   //nsISupports
   NS_DECL_ISUPPORTS
 
-  //nsIDragSession and nsIDragService
+  //nsIDragSession, nsIDragService and nsPIDragService
   NS_DECL_NSIDRAGSERVICE
+  NS_DECL_NSPIDRAGSERVICE
   NS_DECL_NSIDRAGSESSION
 
-  void SetDragEndPoint(nsIntPoint aEndDragPoint) { mEndDragPoint = aEndDragPoint; }
-
-  PRUint16 GetInputSource() { return mInputSource; }
-
 protected:
 
   /**
-- 
1.7.5.4

